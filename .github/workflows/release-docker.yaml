name: Build and Push Miles Docker Image

on:
  workflow_dispatch:
    inputs:
      megatron_repo:
        description: 'Megatron repository (owner/repo)'
        required: true
        default: 'NVIDIA/Megatron-LM'
      megatron_commit:
        description: 'Megatron commit SHA (leave empty for latest)'
        required: false
        default: ''
      miles_repo:
        description: 'Miles repository (owner/repo)'
        required: true
        default: 'radixark/miles'
      miles_commit:
        description: 'Miles commit SHA (leave empty for latest)'
        required: false
        default: ''
      sglang_repo:
        description: 'SGLang repository (owner/repo)'
        required: true
        default: 'sgl-project/sglang'
      sglang_commit:
        description: 'SGLang commit SHA (leave empty for latest)'
        required: false
        default: ''
      tag:
        description: 'Optional custom tag (leave empty for auto-generated)'
        required: false
        default: ''

jobs:
  build-and-push:
    runs-on: ubuntu-latest-8-core  # What runners do we have available for miles?
    steps:
      - name: Clone repositories
        env:
          # Use REPO_ACCESS_TOKEN if available, otherwise fall back to github.token
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN || github.token }}
        run: |
          git clone --recursive https://${{ secrets.REPO_ACCESS_TOKEN || github.token }}@github.com/${{ inputs.megatron_repo }} megatron
          cd megatron
          if [ -n "${{ inputs.megatron_commit }}" ]; then
            git checkout ${{ inputs.megatron_commit }} && git reset --hard ${{ inputs.megatron_commit }}
          fi
          cd ..

          git clone --recursive https://${{ secrets.REPO_ACCESS_TOKEN || github.token }}@github.com/${{ inputs.miles_repo }} miles
          cd miles
          if [ -n "${{ inputs.miles_commit }}" ]; then
            git checkout ${{ inputs.miles_commit }} && git reset --hard ${{ inputs.miles_commit }}
          fi
          cd ..

          git clone --recursive https://${{ secrets.REPO_ACCESS_TOKEN || github.token }}@github.com/${{ inputs.sglang_repo }} sglang
          cd sglang
          if [ -n "${{ inputs.sglang_commit }}" ]; then
            git checkout ${{ inputs.sglang_commit }} && git reset --hard ${{ inputs.sglang_commit }}
          fi
          cd ..

      - name: Generate tag
        id: tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            MEGATRON_SHA=$(cd megatron && git rev-parse --short HEAD)
            MILES_SHA=$(cd miles && git rev-parse --short HEAD)
            SGLANG_SHA=$(cd sglang && git rev-parse --short HEAD)
            echo "tag=megatron-${MEGATRON_SHA}-miles-${MILES_SHA}-sglang-${SGLANG_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Write Dockerfile
        run: |
          cat << 'EOF' > Dockerfile
          FROM radixark/miles@sha256:6e467519505da8407f8c33e3c5ec622c0cc4e6e0929102efe34f8415940caf06
          RUN rm -rf /root/miles /root/Megatron-LM /sgl-workspace/sglang
          RUN pip uninstall -y miles megatron sglang || true
          RUN pip install flashinfer-jit-cache==0.6.2 --index-url https://flashinfer.ai/whl/cu129
          RUN apt remove -y libgtest-dev || true
          RUN pip install z3-solver cython
          RUN cd /tmp && rm -rf tilelang && git clone https://github.com/tile-ai/tilelang.git && cd tilelang && pip install -e . -v --no-build-isolation
          RUN cd /tmp && rm -rf fast-hadamard-transform && git clone https://github.com/Dao-AILab/fast-hadamard-transform.git && cd fast-hadamard-transform && pip install -e . -v --no-build-isolation
          RUN cd /tmp && rm -rf flash-mla && git clone https://github.com/deepseek-ai/FlashMLA.git flash-mla && cd flash-mla && git submodule update --init --recursive && pip install --no-build-isolation -v .
          COPY megatron /root/megatron
          RUN cd /root/megatron && pip install -e .
          COPY sglang /root/sglang
          RUN cd /root/sglang/python && pip install -e .
          COPY miles /root/miles
          RUN cd /tmp && rm -rf transformers && git clone https://github.com/huggingface/transformers.git && cd transformers && git checkout 8cb5963cc22174954e7dca2c0a3320b7dc2f4edc && pip install -e .
          RUN cd /root/miles && pip install -e .
          EOF

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/miles:${{ steps.tag.outputs.tag }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/miles:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/miles:buildcache,mode=max