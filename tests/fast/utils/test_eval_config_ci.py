"""Auto-generated tests for commit 257fe908: add fsdp assert back

Tests the changes introduced in branch auto/20260202221742 relative to main.
Generated by /auto-ci skill.
"""

import pytest

from miles.utils.eval_config import EvalDatasetConfig


class TestEvalDatasetConfigCustomGenerateFunctionPath:
    """Tests for the new custom_generate_function_path field on EvalDatasetConfig."""

    def test_default_is_none(self):
        """custom_generate_function_path should default to None."""
        cfg = EvalDatasetConfig(name="test", path="/data/test")
        assert cfg.custom_generate_function_path is None

    def test_set_custom_generate_function_path(self):
        """custom_generate_function_path can be set to a module path."""
        cfg = EvalDatasetConfig(
            name="tool_calling",
            path="/data/tool_calling",
            custom_generate_function_path="miles.rollout.tool_gen:generate",
        )
        assert cfg.custom_generate_function_path == "miles.rollout.tool_gen:generate"

    def test_not_in_cache_key(self):
        """custom_generate_function_path should NOT affect cache_key (it's not in the tuple)."""
        cfg1 = EvalDatasetConfig(name="test", path="/data/test", custom_generate_function_path=None)
        cfg2 = EvalDatasetConfig(name="test", path="/data/test", custom_generate_function_path="mod:func")
        assert cfg1.cache_key == cfg2.cache_key

    def test_inject_metadata_unaffected(self):
        """custom_generate_function_path should not leak into inject_metadata."""
        cfg = EvalDatasetConfig(
            name="test",
            path="/data/test",
            custom_generate_function_path="mod:func",
        )
        metadata = cfg.inject_metadata(None)
        assert "custom_generate_function_path" not in metadata

    def test_assignment_to_sample(self):
        """Simulates the eval_rollout_single_dataset flow: cfg path -> sample."""
        from miles.utils.types import Sample

        cfg = EvalDatasetConfig(
            name="tool_eval",
            path="/data/tool_eval",
            custom_generate_function_path="miles.tool:custom_gen",
        )
        sample = Sample(prompt="test")
        # This is the pattern used in eval_rollout_single_dataset:
        sample.generate_function_path = getattr(cfg, "custom_generate_function_path", None)
        assert sample.generate_function_path == "miles.tool:custom_gen"

    def test_assignment_to_sample_when_none(self):
        """When cfg has no custom path, sample gets None."""
        from miles.utils.types import Sample

        cfg = EvalDatasetConfig(name="basic", path="/data/basic")
        sample = Sample(prompt="test")
        sample.generate_function_path = getattr(cfg, "custom_generate_function_path", None)
        assert sample.generate_function_path is None
